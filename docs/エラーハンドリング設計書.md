# エラーハンドリング設計書

## 1. 目的
本ドキュメントは、ヨルノートにおけるエラーハンドリングの方針と詳細設計を定義する。
ユーザーに適切なフィードバックを提供し、また開発者が問題解決を迅速に行えるように、エラーを分類し、それぞれに対する振る舞いを規定する。

## 2. エラー分類定義

発生しうる事象を以下の3つに分類する。

| 分類 | 定義 | 具体例 | 基本的な対応方針 |
| :--- | :--- | :--- | :--- |
| **正常なエラー** (Normal/Expected Errors) | ユーザー操作やビジネスロジック上で**想定される**否認・失敗。システムとしては正常動作。 | ・入力フォームの空文字列<br>・操作キャンセル<br>・検索結果0件<br>・同日の重複エントリ | ・インラインメッセージで理由を提示<br>・再操作を促す<br>・無効な操作を無視 |
| **異常なエラー** (Abnormal/System Errors) | システム外部要因や環境要因で発生する障害。ユーザー側で一時的な解決や回避が可能な場合がある。 | ・SwiftDataの保存失敗<br>・ディスク容量不足<br>・メモリ不足<br>・ファイルアクセス権限エラー | ・アラートダイアログを表示<br>・リトライオプションの提示<br>・ログ出力 |
| **想定外のエラー** (Unexpected/Fatal Errors) | 本来起こるべきではないプログラムのバグや論理矛盾。継続不可能な状態。 | ・ModelContainer初期化失敗<br>・Null参照エラー (Bug)<br>・スキーマ不整合<br>・メモリリーク | ・アプリクラッシュ（fatalError）<br>・詳細ログの出力<br>・アプリの再起動を促す |

## 3. レイヤー別方針

### 3.1. App Layer (yorunoteApp.swift)
- **ModelContainer初期化**: `fatalError` でアプリを終了させる（現在の実装通り）
- **スキーマエラー**: 回復不可能なため、アプリ終了
- **ログ**: `print` または `os_log` で詳細なエラー情報を出力

### 3.2. View Layer (SwiftUI Views)
- **データ操作エラー**: `@State` でエラー状態を管理し、適切なUIフィードバックを表示
- **UIフィードバック**:
    - 軽微なエラー: インラインメッセージ（例：「入力が必要です」）
    - 重大なエラー: Alert Dialog（例：「保存に失敗しました」）
- **Error Boundary**: SwiftUIの `onAppear` や `task` でエラーをキャッチ

### 3.3. Model Layer (SwiftData)
- **データ永続化**: SwiftDataが自動的にエラーをスローするため、上位レイヤーで捕捉
- **トランザクション**: `try-catch` でラップし、失敗時はロールバック
- **データ整合性**: バリデーション失敗時は適切なエラーメッセージを返す

## 4. エラーパターン一覧と対応規定

### A. データ永続化・SwiftData関連

| 機能 | エラー分類 | エラー内容 | 詳細/条件 | 対応規定 (UI挙動) |
| :--- | :--- | :--- | :--- | :--- |
| `ModelContainer`初期化 | 想定外 | 初期化失敗 | スキーマ不整合、ディスク破損 | `fatalError` でアプリ終了 |
| `modelContext.save()` | 異常 | 保存失敗 | ディスク容量不足、権限エラー | アラート表示「保存に失敗しました」 |
| `modelContext.fetch()` | 異常 | 取得失敗 | データベース破損 | アラート表示「データの読み込みに失敗しました」 |
| `NightEntry`作成 | 正常 | バリデーションエラー | 必須フィールド未入力 | インラインメッセージ表示 |

### B. ユーザー入力・フォーム関連

| 機能 | エラー分類 | エラー内容 | 詳細/条件 | 対応規定 (UI挙動) |
| :--- | :--- | :--- | :--- | :--- |
| `RitualInputView`保存 | 正常 | 全フィールド空 | すべてのテキストフィールドが空 | 保存ボタンを無効化 |
| `RitualInputView`保存 | 異常 | 保存処理失敗 | SwiftDataエラー | アラート「保存に失敗しました。もう一度お試しください」 |
| 日付選択 | 正常 | 未来日選択 | 今日より後の日付 | 「今日の儀式を始める」ボタンを非表示 |
| 操作キャンセル | 正常 | ユーザーキャンセル | 入力途中でキャンセル | 何もしない（画面を閉じる） |

### C. シュレッダー機能関連

| 機能 | エラー分類 | エラー内容 | 詳細/条件 | 対応規定 (UI挙動) |
| :--- | :--- | :--- | :--- | :--- |
| タイマー処理 | 異常 | タイマー停止失敗 | システムリソース不足 | 手動リセット機能を提供 |
| テキスト削除 | 正常 | 空テキスト | 入力なしで削除実行 | 削除ボタンを無効化 |
| アニメーション | 異常 | 描画エラー | メモリ不足、GPU問題 | アニメーションをスキップして完了画面へ |

### D. ナビゲーション・UI関連

| 機能 | エラー分類 | エラー内容 | 詳細/条件 | 対応規定 (UI挙動) |
| :--- | :--- | :--- | :--- | :--- |
| `Sheet`表示 | 異常 | モーダル表示失敗 | メモリ不足 | アラート「画面の表示に失敗しました」 |
| `TabView`切り替え | 正常 | 状態不整合 | 予期しないタブ選択 | デフォルトタブ（ホーム）に戻す |
| `DatePicker` | 正常 | 無効な日付 | システム日付設定異常 | 現在日付にリセット |

## 5. 実装状況チェックリスト

- [x] **ModelContainer**: 初期化失敗時の `fatalError` 処理
    - `yorunoteApp.swift`: スキーマエラーは回復不可能なため適切
- [x] **RitualInputView**: 保存エラーハンドリングの実装
    - `saveEntry()` メソッドに `try-catch` を追加
    - エラー時のアラート表示機能
    - `ErrorMessages`と`ErrorLogger`を使用
- [x] **HomeView**: データ処理の安全性向上
    - `findEntry()` メソッドに安全性チェック追加
    - 空データの適切な処理
    - 情報ログの出力
- [x] **ShredderView**: タイマー処理の安全性向上
    - タイマー処理の分離と安全性向上
    - アニメーション処理の構造化
    - エラー時のリセット機能
- [x] **共通エラーハンドリング**: 統一されたエラー管理
    - `ErrorHandling.swift`で`ErrorMessages`と`ErrorLogger`を実装
    - 再利用可能なエラーメッセージ定数
    - 構造化されたログ出力機能
- [x] **実用的なエラーハンドリング**: 実際にエラーが発生する箇所に限定
    - 過度な`try-catch`を避けて安定性を確保
    - ユーザーフレンドリーなエラーメッセージ
    - 開発者向けの詳細ログ

## 6. エラーメッセージ

### 6.1. ユーザー向けメッセージ
- **保存失敗**: 「保存に失敗しました。もう一度お試しください。」
- **読み込み失敗**: 「データの読み込みに失敗しました。アプリを再起動してください。」
- **入力エラー**: 「すべてのフィールドが空です。何か入力してください。」
- **システムエラー**: 「予期しないエラーが発生しました。アプリを再起動してください。」

### 6.2. 開発者向けログメッセージ
- **SwiftDataエラー**: `"SwiftData Error: \(error.localizedDescription)"`
- **メモリエラー**: `"Memory Warning: Low memory detected"`
- **パフォーマンス**: `"Performance Warning: Operation took \(time)s"`

## 7. テスト方針

### 7.1. 単体テスト
- 各エラーパターンの発生条件を再現
- エラーハンドリングロジックの動作確認
- エラーメッセージの内容検証

### 7.2. 統合テスト
- エラー発生時のUI状態確認
- データ整合性の維持確認
- ユーザーフローの継続性確認

### 7.3. パフォーマンステスト
- 大量データでのエラー処理性能
- メモリ不足時の挙動確認
- 長時間使用時の安定性確認