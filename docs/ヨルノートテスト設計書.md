# ヨルノート テスト設計書

## 1. 概要
本ドキュメントは、ヨルノート（夜の3分間で心をリセットするiOSアプリ）の品質を担保するためのテスト方針と設計をまとめたものである。

## 2. テストレベルと範囲

| レベル | 対象 | 目的 | ツール |
| :--- | :--- | :--- | :--- |
| **ユニットテスト** | SwiftDataモデル, ビジネスロジック | 個々のデータモデルとロジックの動作確認 | XCTest |
| **UIテスト** | SwiftUIビュー, ユーザーインタラクション | UI表示とユーザー操作の動作確認 | XCUITest |
| **統合テスト** | データ永続化, ビュー間連携 | SwiftDataとUIの連携、画面遷移の検証 | XCTest + XCUITest |

---

## 3. データモデルテスト設計
`NightEntry.swift` を対象とする。

### 3.1. テスト方法
*   **In-Memory Database**: テスト用のModelContainerを使用し、実際のファイルシステムに影響を与えない。
*   **データ永続化**: SwiftDataの保存・読み込み機能を検証する。
*   **日付処理**: Calendar APIを使った日付比較ロジックを検証する。

### 3.2. テスト対象とケース一覧

#### A. NightEntryモデル
**目標カバレッジ: C1 100%**
データモデルの基本機能を網羅する。

| 機能 | テストケースID | 説明 | 期待値 | 備考 |
| :--- | :--- | :--- | :--- | :--- |
| **初期化** | `MODEL-001` | デフォルト値での初期化 | 全フィールドが適切に設定されること | UUID生成、現在日時設定 |
| | `MODEL-002` | 全パラメータ指定での初期化 | 指定した値が正しく設定されること | |
| | `MODEL-003` | 空文字列での初期化 | 空文字列が正しく保存されること | |
| **データ保存** | `MODEL-011` | 新規エントリ保存 | ModelContextに正しく保存されること | |
| | `MODEL-012` | 既存エントリ更新 | 既存データが正しく更新されること | |
| | `MODEL-013` | 複数エントリ保存 | 複数のエントリが独立して保存されること | |
| **データ取得** | `MODEL-021` | 日付順ソート取得 | 日付の降順で取得されること | @Query(sort: \\NightEntry.date, order: .reverse) |
| | `MODEL-022` | 特定日付のエントリ検索 | 指定日と同じ日のエントリが取得されること | Calendar.isDate(_:inSameDayAs:) |
| | `MODEL-023` | 存在しない日付の検索 | nilまたは空配列が返されること | |

#### B. データ永続化

| 機能 | テストケースID | 説明 | 期待値 |
| :--- | :--- | :--- | :--- |
| **ModelContainer** | `PERSIST-001` | アプリ起動時の初期化 | ModelContainerが正常に作成されること |
| | `PERSIST-002` | スキーマ設定 | NightEntryスキーマが正しく設定されること |
| | `PERSIST-003` | 永続化設定 | isStoredInMemoryOnly: falseが適用されること |
| **データ復旧** | `PERSIST-011` | アプリ再起動後のデータ | 保存したデータが再起動後も取得できること |
| | `PERSIST-012` | 大量データ保存 | 100件以上のエントリが正常に保存・取得できること |

---

## 4. UIテスト設計
各Viewコンポーネントのユーザーインタラクションを対象とする。

### 4.1. テスト方法
*   **XCUITest**: 実際のUIコンポーネントを操作してテストする。
*   **Preview Provider**: SwiftUIプレビューを活用した単体テスト。
*   **Mock Data**: テスト用のNightEntryデータを事前に準備する。

### 4.2. テスト対象とケース一覧

#### A. ContentView

| 機能 | テストケースID | 説明 | 期待値 |
| :--- | :--- | :--- | :--- |
| **タブ切り替え** | `UI-001` | ホームタブ選択 | HomeViewが表示されること |
| | `UI-002` | シュレッダータブ選択 | ShredderViewが表示されること |
| | `UI-003` | カラースキーム切り替え | シュレッダータブでダークモードになること |

#### B. HomeView

| 機能 | テストケースID | 説明 | 期待値 |
| :--- | :--- | :--- | :--- |
| **カレンダー表示** | `HOME-001` | 初期表示 | 現在日付が選択されていること |
| | `HOME-002` | 日付選択 | タップした日付が選択されること |
| | `HOME-003` | 記録ありの日表示 | エントリがある日の表示が変わること |
| **エントリ表示** | `HOME-011` | 記録なしの場合 | 「記録はありません」メッセージが表示されること |
| | `HOME-012` | 記録ありの場合 | エントリの概要が表示されること |
| | `HOME-013` | 今日の場合 | 「今日の儀式を始める」ボタンが表示されること |
| **ボタン操作** | `HOME-021` | 儀式開始ボタンタップ | RitualInputViewが表示されること |
| | `HOME-022` | 内容確認ボタンタップ | 既存エントリでRitualInputViewが表示されること |

#### C. RitualInputView

| 機能 | テストケースID | 説明 | 期待値 |
| :--- | :--- | :--- | :--- |
| **フォーム表示** | `RITUAL-001` | 新規作成モード | 空のフォームが表示されること |
| | `RITUAL-002` | 編集モード | 既存データがフォームに表示されること |
| **入力操作** | `RITUAL-011` | テキスト入力 | 各フィールドに文字が入力できること |
| | `RITUAL-012` | 複数行入力 | 改行を含む長文が入力できること |
| | `RITUAL-013` | 空入力での保存 | 全て空の場合は保存ボタンが無効になること |
| **保存処理** | `RITUAL-021` | 新規保存 | 新しいNightEntryが作成されること |
| | `RITUAL-022` | 更新保存 | 既存エントリが更新されること |
| | `RITUAL-023` | キャンセル操作 | 変更が破棄されてモーダルが閉じること |

#### D. ShredderView

| 機能 | テストケースID | 説明 | 期待値 |
| :--- | :--- | :--- | :--- |
| **タイマー機能** | `SHRED-001` | 初期状態 | 60秒が表示されること |
| | `SHRED-002` | 入力開始でタイマー開始 | 文字入力でカウントダウンが始まること |
| | `SHRED-003` | タイマー終了 | 0秒になったら自動でシュレッダー開始 |
| **テキスト入力** | `SHRED-011` | 自由入力 | 制限なくテキストが入力できること |
| | `SHRED-012` | 入力中の表示 | 入力した文字が即座に表示されること |
| **シュレッダー機能** | `SHRED-021` | 手動実行 | 「スッキリする」ボタンでアニメーション開始 |
| | `SHRED-022` | アニメーション表示 | シュレッダーアニメーションが表示されること |
| | `SHRED-023` | データ消去 | アニメーション後にテキストが完全に消去されること |
| | `SHRED-024` | 完了画面表示 | 「頭の中が空っぽになりました」が表示されること |
| **リセット機能** | `SHRED-031` | もう一度書くボタン | 初期状態にリセットされること |
| | `SHRED-032` | タイマーリセット | 60秒に戻ること |

---

## 5. 統合テスト設計
アプリ全体の動作フローを対象とする。

### 5.1. テスト対象とケース一覧

#### A. エンドツーエンドフロー

| 機能 | テストケースID | 説明 | 期待値 |
| :--- | :--- | :--- | :--- |
| **完全な儀式フロー** | `E2E-001` | 新規エントリ作成から表示まで | ホーム→入力→保存→カレンダー表示の一連の流れ |
| | `E2E-002` | エントリ編集フロー | 既存エントリの表示→編集→保存→更新確認 |
| | `E2E-003` | 複数日のエントリ管理 | 異なる日付で複数エントリを作成し、正しく管理されること |
| **シュレッダーフロー** | `E2E-011` | 完全なシュレッダー体験 | 入力→タイマー→アニメーション→リセットの流れ |
| | `E2E-012` | タブ間移動 | シュレッダー使用後にホームタブに戻っても影響がないこと |

#### B. データ整合性

| 機能 | テストケースID | 説明 | 期待値 |
| :--- | :--- | :--- | :--- |
| **日付境界** | `DATA-001` | 日付変更時の動作 | 日付が変わった時の新規エントリ作成 |
| | `DATA-002` | タイムゾーン考慮 | 異なるタイムゾーンでの日付処理 |
| **同時操作** | `DATA-011` | 複数画面での同時編集 | データの整合性が保たれること |

---

## 6. パフォーマンステスト設計

### 6.1. テスト対象とケース一覧

#### A. レスポンス性能

| 機能 | テストケースID | 説明 | 期待値 |
| :--- | :--- | :--- | :--- |
| **画面遷移** | `PERF-001` | タブ切り替え速度 | 0.5秒以内で切り替わること |
| | `PERF-002` | モーダル表示速度 | 0.3秒以内で表示されること |
| **データ処理** | `PERF-011` | 大量データ読み込み | 1年分のエントリ（365件）を1秒以内で読み込めること |
| | `PERF-012` | カレンダー描画 | エントリマーク付きカレンダーが2秒以内で描画されること |

#### B. メモリ使用量

| 機能 | テストケースID | 説明 | 期待値 |
| :--- | :--- | :--- | :--- |
| **メモリリーク** | `MEM-001` | 長時間使用 | 30分間の連続使用でメモリリークが発生しないこと |
| | `MEM-002` | 画面遷移繰り返し | 100回の画面遷移でメモリが適切に解放されること |

---

## 7. アクセシビリティテスト設計

### 7.1. テスト対象とケース一覧

#### A. VoiceOver対応

| 機能 | テストケースID | 説明 | 期待値 |
| :--- | :--- | :--- | :--- |
| **ナビゲーション** | `A11Y-001` | タブバーの読み上げ | 各タブの名称が正しく読み上げられること |
| | `A11Y-002` | ボタンの読み上げ | 全てのボタンに適切なラベルがあること |
| **フォーム入力** | `A11Y-011` | テキストフィールド | 各入力欄の目的が明確に伝わること |
| | `A11Y-012` | 保存状態の通知 | 保存完了時に音声フィードバックがあること |

#### B. 動的文字サイズ対応

| 機能 | テストケースID | 説明 | 期待値 |
| :--- | :--- | :--- | :--- |
| **文字サイズ変更** | `DYN-001` | 最小サイズ | 全てのテキストが読める状態を保つこと |
| | `DYN-002` | 最大サイズ | レイアウトが崩れないこと |

---

## 8. エラーハンドリングテスト設計

### 8.1. テスト対象とケース一覧

#### A. データベースエラー

| 機能 | テストケースID | 説明 | 期待値 |
| :--- | :--- | :--- | :--- |
| **保存失敗** | `ERR-001` | ディスク容量不足 | 適切なエラーメッセージが表示されること |
| | `ERR-002` | データベース破損 | アプリがクラッシュしないこと |
| **読み込み失敗** | `ERR-011` | データ取得エラー | 空の状態で正常に動作すること |

#### B. システムエラー

| 機能 | テストケースID | 説明 | 期待値 |
| :--- | :--- | :--- | :--- |
| **メモリ不足** | `SYS-001` | 低メモリ状態 | 適切にメモリを解放して継続動作すること |
| **バックグラウンド復帰** | `SYS-011` | アプリ復帰時 | 入力中のデータが保持されていること |

---

## 9. テストデータ
*   **Mock Entries**: テストで使用する固定のNightEntryデータを `Tests/Fixtures/` に定義する。
*   **Date Utilities**: 特定日付のテストデータ生成ユーティリティを作成する。
*   **Setup Methods**: 各テストクラスで共通のセットアップ処理を定義する。
